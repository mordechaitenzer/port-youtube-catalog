name: Ingest Youtube Playlist to Port
on:
  workflow_dispatch:

jobs:
  ingest-to-port:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Format YouTube Data
        id: youtube_data
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          PLAYLIST_ID: "PL5ErBr2d3QJH0kbwTQ7HSuzvBb4zIWzhy"
        run: |
          pip install requests isodate
          python - <<EOF
          import requests, os, json, isodate
          
          def get_entities():
              api_key = os.environ['YOUTUBE_API_KEY']
              playlist_id = os.environ['PLAYLIST_ID']
              
              # Fetch Playlist metadata
              pl_res = requests.get(f"https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails&id={playlist_id}&key={api_key}").json()["items"][0]
              
              # Initialize entities list with the Playlist itself
              entities = [{
                  "identifier": playlist_id,
                  "blueprint": "youtube_playlist",
                  "title": pl_res["snippet"]["title"],
                  "properties": {
                      "link": f"https://www.youtube.com/playlist?list={playlist_id}",
                      "video_count": pl_res["contentDetails"]["itemCount"]
                  }
              }]

              # Fetch up to 50 items from the Playlist
              v_items = requests.get(f"https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=50&playlistId={playlist_id}&key={api_key}").json().get("items", [])
              
              for item in v_items:
                  v_id = item["contentDetails"]["videoId"]
                  v_title = item["snippet"]["title"]
                  
                  # Fetch specific video metrics (Views, Likes, Duration)
                  v_info = requests.get(f"https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails,snippet&id={v_id}&key={api_key}").json()["items"][0]
                  
                  # Create Video Entity with dynamic properties
                  entities.append({
                      "identifier": v_id,
                      "blueprint": "youtube_video",
                      "title": v_title,
                      "properties": {
                          "title": v_title,
                          "link": f"https://www.youtube.com/watch?v={v_id}",
                          "views": int(v_info["statistics"].get("viewCount", 0)),
                          "likes": int(v_info["statistics"].get("likeCount", 0)),
                          "titleLength": len(v_title),
                          "durationSeconds": int(isodate.parse_duration(v_info["contentDetails"]["duration"]).total_seconds()),
                          "isOfficialSource": v_info["contentDetails"].get("licensedContent", False),
                          "thumbnail": item["snippet"]["thumbnails"]["high"]["url"],
                          "publishedAt": item["snippet"]["publishedAt"]
                      },
                      "relations": {"playlist": playlist_id}
                  })
              return entities

          # Export the dynamic list to GitHub Actions Output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"entities={json.dumps(get_entities())}\n")
          EOF

      - name: Bulk Upsert to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: BULK_UPSERT
          # This maps the YouTube data directly to your Port Blueprints
          entities: ${{ steps.youtube_data.outputs.entities }}
